---
title: "Data preprocessing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
setwd("/scratch/dongelr1/susannar/kesa2024")

library(dplyr)
library(purrr)
library('stringr')
library(lubridate)
library(zoo)
```

Preprocess and merge the SMEAR II data into one dataframe
```{r}
merge_smear_data <- function(folder_path) {
  x <- list.files(path = folder_path, full.names = TRUE) %>%
    lapply(read.csv) %>%
    lapply(function(x) {x$Time <- as.POSIXct(str_c(x$Year, "-", x$Month, "-", x$Day, " ", x$Hour, ":", x$Minute, ":00"), format="%Y-%m-%d %H:%M:%S", tz="UTC");x}) %>%
    lapply(function(x) arrange(x, Time)) %>%
    lapply(function(x) x[!names(x) %in% c("Minute","Second", "Hour", "Day", "Year", "Month")]) %>%
    lapply(function(x) arrange(x, Time)) %>%
    reduce(cbind) %>%
    .[unique(colnames(.))]
  return(x)
}
```

Load SMEAR data for years 2011-2013, 2018-2019 and 2022. Parameters are global radiation, SO2, O3, NOx, relative humidity, air pressure, air temperature, wind speed and wind direction
```{r}
path1113 <- "/scratch/dongelr1/susannar/kesa2024/data/smear_hyytiala_2011_2013/"
path1819 <- "/scratch/dongelr1/susannar/kesa2024/data/smear_hyytiala_2018_2019/"
path22 <- "/scratch/dongelr1/susannar/kesa2024/data/smear_hyytiala_2022/"
hyytiala1113 <- merge_smear_data(path1113)
hyytiala1819 <- merge_smear_data(path1819)
hyytiala22 <- merge_smear_data(path22)
```

Preprocess the SA measurement data, the unit is the number of SA molecules in cm^3
```{r}
preprocess_sa_data <- function(folder_path) {
  x <- list.files(path = folder_path, full.names = TRUE) %>%
    lapply(read.table) %>%
    lapply(function(x) {names(x) <- c("Time", "SA_cm3", "3", "4"); x}) %>%
    lapply(function(x) {x[3:4] <- list(NULL); x}) %>%
    lapply(function(x) {y <- mutate(x, Time=as.POSIXct((Time - 719529)*86400, origin = "1970-01-01", tz="UTC")); y}) %>%
    lapply(function(x) arrange(x, Time))
    return(x)
}
```

```{r}
sa_path <- "/scratch/dongelr1/susannar/kesa2024/data/hyytiala/sulphuric_acid/"
sa <- preprocess_sa_data(sa_path)
```



Load and preprocess the condensation sink data

```{r}
cs_path <- "data/hyytiala/condensation_sink/CS_2004_2023_10min.txt"
cs_all <- read.table(cs_path, col.names = c("Year", "Month", "Day", "Hour", "Minute", "Second", "CS_rate"))
cs <- filter(cs_all, (Year >= 2011 & Year <= 2013) | (Year >= 2018 & Year <= 2019) | (Year == 2022))
cs$Time <- as.POSIXct(str_c(cs$Year, "-", cs$Month, "-", cs$Day, " ", cs$Hour, ":", cs$Minute, ":00"), format="%Y-%m-%d %H:%M:%S", tz="UTC")
cs <- cs[!names(cs) %in% c("Minute","Second", "Hour", "Day", "Year", "Month")]

cs$Time <- floor_date(cs$Time, "30 mins")
cs <- group_by(cs, Time)
cs <- summarise(cs, CS_rate = mean(CS_rate, na.rm = FALSE))
```


Combine SA, CS and the SMEAR II data into one frame for each time period

```{r}

```


Write to file?
```{r}
#write.table(hyytiala1113, "data/smear-hyytiala-2011-2013/smear-merged.csv")
#write.table(hyytiala1819, "data/smear-hyytiala-2011-2013/smear-merged.csv")
#write.table(hyytiala22, "data/smear-hyytiala-2011-2013/smear-merged.csv")
```
