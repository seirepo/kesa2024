---
title: "Data preprocessing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
setwd("/scratch/dongelr1/susannar/kesa2024")

library(dplyr)
library(purrr)
library('stringr')
library(lubridate)
library(zoo)
library(ggplot2)
library(ggpubr)
```

Preprocess and merge the SMEAR II data into one dataframe
```{r}
merge_smear_data <- function(folder_path) {
  x <- list.files(path = folder_path, full.names = TRUE) %>%
    lapply(read.csv) %>%
    lapply(function(x) {x$Time <- as.POSIXct(str_c(x$Year, "-", x$Month, "-", x$Day, " ", x$Hour, ":", x$Minute, ":00"), format="%Y-%m-%d %H:%M:%S", tz="UTC");x}) %>%
    lapply(function(x) arrange(x, Time)) %>%
    lapply(function(x) x[!names(x) %in% c("Minute","Second", "Hour", "Day", "Year", "Month")]) %>%
    lapply(function(x) arrange(x, Time)) %>%
    reduce(cbind) %>%
    .[unique(colnames(.))]
  return(x)
}
```

Load SMEAR data for years 2011-2013, 2018-2019 and 2022. Parameters are global radiation, SO2, O3, NOx, relative humidity, air pressure, air temperature, wind speed and wind direction
```{r}
path1113 <- "/scratch/dongelr1/susannar/kesa2024/data/smear_hyytiala_2011_2013/"
path1819 <- "/scratch/dongelr1/susannar/kesa2024/data/smear_hyytiala_2018_2019/"
path22 <- "/scratch/dongelr1/susannar/kesa2024/data/smear_hyytiala_2022/"
hyytiala1113 <- merge_smear_data(path1113)
hyytiala1819 <- merge_smear_data(path1819)
hyytiala22 <- merge_smear_data(path22)
```

Preprocess the SA measurement data, the unit is the number of SA molecules in cm^3
```{r}
preprocess_sa_data <- function(folder_path) {
  x <- list.files(path = folder_path, full.names = TRUE) %>%
    lapply(read.table) %>%
    lapply(function(x) {names(x) <- c("Time", "SA_cm3", "3", "4"); x}) %>%
    lapply(function(x) {x[3:4] <- list(NULL); x}) %>%
    lapply(function(x) {y <- mutate(x, Time=as.POSIXct((Time - 719529)*86400, origin = "1970-01-01", tz="UTC")); y}) %>%
    lapply(function(x) arrange(x, Time))
    return(x)
}
```

```{r}
sa_path <- "/scratch/dongelr1/susannar/kesa2024/data/hyytiala/sulphuric_acid/"
sa <- preprocess_sa_data(sa_path)
```



Load and preprocess the condensation sink data

```{r}
cs_path <- "data/hyytiala/condensation_sink/CS_2004_2023_10min.txt"
cs_all <- read.table(cs_path, col.names = c("Year", "Month", "Day", "Hour", "Minute", "Second", "CS_rate"))
cs <- filter(cs_all, (Year >= 2011 & Year <= 2013) | (Year >= 2018 & Year <= 2019) | (Year == 2022))
cs$Time <- as.POSIXct(str_c(cs$Year, "-", cs$Month, "-", cs$Day, " ", cs$Hour, ":", cs$Minute, ":00"), format="%Y-%m-%d %H:%M:%S", tz="UTC")
cs <- cs[!names(cs) %in% c("Minute","Second", "Hour", "Day", "Year", "Month")]

cs$Time <- floor_date(cs$Time, "30 mins")
cs <- group_by(cs, Time)
cs <- summarise(cs, CS_rate = mean(CS_rate, na.rm = FALSE))
```


Combine SA, CS and the SMEAR II data into one frame for each time period

```{r}

```


Write to file?
```{r}
#write.table(hyytiala1113, "data/smear_hyytiala_2011_2013/2011_2013_merged.csv")
#write.table(hyytiala1819, "data/smear_hyytiala_2018_2019/2018_2019_merged.csv")
#write.table(hyytiala22, "data/smear_hyytiala_2022/2022_merged.csv")
```



# Ploting SA data


Plot 20.3. in 2011, rounded and unrounded, and 2018 for comparison
```{r}
sa2011 <- filter(sa[[4]], Time %within% interval(start = ymd_hms("2011-03-20-00-00-00"), end = ymd_hms("2011-03-20-23-59-59")))

ggplot(sa2011, aes(Time, SA_cm3)) +
           geom_point(na.rm=TRUE) + 
           ggtitle("20.3.2011, unrounded")


sa2011$Time <- round_date(sa2011$Time, unit="30 mins")
sa2011 <- group_by(sa2011, Time)
sa2011_rounded <- summarize(sa2011, SA_cm3=mean(SA_cm3, na.rm=TRUE))

ggplot(sa2011_rounded, aes(Time, SA_cm3)) +
           geom_point(na.rm=TRUE) + 
           ggtitle("20.3.2011, rounded to nearest 30 min")
```

The same day in 2018:
```{r}
sa2018 <- filter(sa[[1]], Time %within% interval(start = ymd_hms("2018-03-20-00-00-00"), end = ymd_hms("2018-03-20-23-59-59")))
#qplot(x=Time, y=SA_cm3,
#      data=sa2018, na.rm=TRUE)


ggplot(sa2018, aes(Time, SA_cm3)) +
           geom_point(na.rm=TRUE) + 
           ggtitle("20.3.2018")
```


Testing:

```{r}
#ggplot2.histogram(data=sa2011$SA_cm3, xName="SA cm3")

binwidth = 1e4

#years <- c("2018", "2019", "2022", "2011", "2012", "2013")
#plots <- list()
#for(i in 1:6) {
#  p <- ggplot(sa[[i]], aes(SA_cm3)) +
#  geom_histogram(binwidth = binwidth, na.rm = TRUE) +
#  ggtitle(years[i])
#  plots <- append(plots, p)
#}
#lapply(p, plot)

ggplot(sa[[1]], aes(SA_cm3)) +
  geom_histogram(binwidth = binwidth, na.rm = TRUE) +
  ggtitle("2018")

ggplot(sa[[2]], aes(SA_cm3)) +
  geom_histogram(binwidth = binwidth, na.rm = TRUE) +
  ggtitle("2019")

ggplot(sa[[3]], aes(SA_cm3)) +
  geom_histogram(binwidth = binwidth, na.rm = TRUE) +
  ggtitle("2022")

ggplot(sa[[4]], aes(SA_cm3)) +
  geom_histogram(binwidth = binwidth, na.rm = TRUE) +
  ggtitle("2011")

ggplot(sa[[5]], aes(SA_cm3)) +
  geom_histogram(binwidth = binwidth, na.rm = TRUE) +
  ggtitle("2012")

ggplot(sa[[6]], aes(SA_cm3)) +
  geom_histogram(bins = 35, na.rm = FALSE) +
  ggtitle("2013")

```


```{r}

plot_list <- list(
  p2018 <- ggplot(sa[[1]], aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2018"),
  p2019 <- ggplot(sa[[2]], aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2019"),
  p2022 <- ggplot(sa[[3]], aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2022"),
  p2011 <- ggplot(sa[[4]], aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2011"),
  p2012 <- ggplot(sa[[5]], aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2012"),
  p2013 <- ggplot(sa[[6]], aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2013")
)

plot_list <- list(
    plot1 = ggplot(df, aes(x, y1)) + geom_point(),
    plot2 = ggplot(df, aes(x, y2)) + geom_point()
    )

gridExtra::grid.arrange(grobs = plot_list)


sapply(plot_list, plot)
```
```{r}

bplot_list = list(
  p2018 <- ggplot(sa[[1]], aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2018"),
  p2019 <- ggplot(sa[[2]], aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2019"),
  p2022 <- ggplot(sa[[3]], aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2022"),
  p2011 <- ggplot(sa[[4]], aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2011"),
  p2012 <- ggplot(sa[[5]], aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2012"),
  p2013 <- ggplot(sa[[6]], aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2013")
)
#  bp2018 <- ggplot(sa[[6]], aes(x=Time, y=SA_cm3)) + geom_boxplot(outlier.size=4),

#gridExtra::grid.arrange(grobs = bplot_list)

sapply(bplot_list, plot)

ggplot(sa[[6]], aes(x=Time, y=SA_cm3)) + geom_boxplot(outlier.size=4)
```

```{r}

plot_feature_effect_models <- function(data, title) {
  p <- ggplot(data, aes(y=SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle(title)
  return(p)  
}


years <- list("2018", "2019", "2022", "2011", "2012", "2013")
data <- c(sa[[1]], sa[[2]])
#l1 <- mapply(plot_feature_effect_models, data)#, title=years)
l1 <- mapply(FUN=plot_feature_effect_models, data=sa, title=years, SIMPLIFY=FALSE)

plot1 <- ggarrange(plotlist = l1, common.legend = TRUE, nrow = 2, ncol = 3, legend = "bottom")
plot1

```

```{r}
lapply(sa, function(x) {
  nas <- sum(is.na(x))
  negs <- sum(x$SA_cm3 < 0, na.rm = TRUE)
  return(paste(year(x[1,]$Time), ": NA:", nas, ", negative values:", negs, sep=" "))
  })
```


Add a Year column in SA dataframes and combine them into one
```{r}
sa_path <- "/scratch/dongelr1/susannar/kesa2024/data/hyytiala/sulphuric_acid/"
sa <- preprocess_sa_data(sa_path)

sa[[1]]$Year <- "2018"
sa[[2]]$Year <- "2019"
sa[[3]]$Year <- "2022"
sa[[4]]$Year <- "2011"
sa[[5]]$Year <- "2012"
sa[[6]]$Year <- "2013"

sa_all <- reduce(sa, rbind)
sa_all <- arrange(sa_all, Time)


sa_all$DayMonth <- format(sa_all$Time, "%d/%m")
#sa_all$Time <- as.POSIXct(sa_all$Time)
#data$DayMonth <- format(data$Time, "%d/%m")

```


Plot all years within the same boxplot

```{r}

bplots1 <- ggplot(sa_all[sa_all$Year %in% c("2011", "2012", "2018", "2019", "2022"),], aes(x=Year, y=SA_cm3)) + geom_boxplot(na.rm=TRUE)
bplots2013 <- ggplot(sa_all[sa_all$Year %in% c("2013"),], aes(x=Year, y=SA_cm3)) + geom_boxplot(na.rm=TRUE)

bplots1
bplots2013

#l1 <- list(
#  bplots1 <- ggplot(sa_all[sa_all$Year %in% c("2011", "2012", "2018", "2019", "2022"),], aes(x=Year, y=SA_cm3)) + geom_boxplot(na.rm=TRUE),
#  bplots2013 <- ggplot(sa_all[sa_all$Year %in% c("2013"),], aes(x=Year, y=SA_cm3)) + geom_boxplot(na.rm=TRUE)
#)
#plot1 <- ggarrange(plotlist = l1, common.legend = TRUE, nrow = 2, ncol = 1, legend = "bottom")
#plot1


```


Plot all years as a line/dot plot with the same x axis and y axis (2013 will blow it up)

```{r}
#ggplot(sa_all[sa_all$Year %in% c("2011", "2013", "2012", "2018", "2019", "2022"),], aes(x=Time, y=SA_cm3)) + geom_point(na.rm=TRUE)

month_breaks <- as.Date(paste0("2000-", 1:12, "-01"))
month_labels <- month.abb
sa_all$Date <- as.Date(paste0("2000/", sa_all$DayMonth), format="%Y/%d/%m")

p <- ggplot(sa_all, aes(x = Date, y = SA_cm3)) +
  geom_point(na.rm = TRUE) +
  facet_wrap(~ Year, scales = "free_y", ncol = 2, nrow = 3) +  # Separate plots for each year
  scale_x_date(breaks = month_breaks, labels = month_labels) #, limits = c(min(sa_all$Date), max(sa_all$Date)))
  #scale_x_datetime(date_labels = "%m", date_breaks = "1 month") +  # Formatting x-axis to show months
  #theme_minimal() #+
  #theme(
  #  axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels for readability
  #  panel.spacing = unit(1, "lines")  # Space between facets
  #) +
  #labs(title = "Point Plot for Each Year", x = "Date", y = "Value")
p

```

```{r}
#sa_copy <- data.frame(sa_all)
#na2011 <- summarize(group_by(sa_copy[sa_copy$Year == 2011,], month(Time)), value=sum(is.na(SA_cm3)))
#ggplot(na2011, aes(Time)) +
#  geom_histogram(bins = 2, na.rm = TRUE) +
#  ggtitle("2011")
#test <- group_by(sa_copy, month(Time))
#summarize(test, value=is.na(SA_cm3))
#test

#ggplot(df, aes(x=weight)) + geom_histogram()

sa_all <- sa_all %>% mutate(Month = month(Time))

p_na_neg <- sa_all %>%
  group_by(Year, Month) %>%
  summarise(
    total_count = n(),
    na_count = sum(is.na(SA_cm3)),
    neg_count = sum(SA_cm3 < 0, na.rm = TRUE),
    na_p = (na_count / total_count),
    neg_p = (neg_count / total_count))
  #) %>%
  #select(Year, na_percentage, neg_percentage) #%>%
  #pivot_longer(cols = c(na_percentage, neg_percentage), names_to = "type", values_to = "percentage")


na_counts <- sa_all %>%
  group_by(Year, Month) %>%
  summarise(na_count = sum(is.na(SA_cm3))) #%>%
  #ungroup()


```


```{r}
na_p11 <- ggplot(p_na_neg[p_na_neg$Year == "2011",], aes(x = factor(Month), y = na_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2011")
na_p12 <- ggplot(p_na_neg[p_na_neg$Year == "2012",], aes(x = factor(Month), y = na_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2012")
na_p13 <- ggplot(p_na_neg[p_na_neg$Year == "2013",], aes(x = factor(Month), y = na_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2013")
na_p18 <- ggplot(p_na_neg[p_na_neg$Year == "2018",], aes(x = factor(Month), y = na_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2018")
na_p19 <- ggplot(p_na_neg[p_na_neg$Year == "2019",], aes(x = factor(Month), y = na_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2019")
na_p22 <- ggplot(p_na_neg[p_na_neg$Year == "2022",], aes(x = factor(Month), y = na_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2022")

pplots <- list(na_p11, na_p12, na_p13, na_p18, na_p19, na_p22)

ggarrange(plotlist = pplots, common.legend = TRUE, nrow = 3, ncol = 2, legend = "bottom")
```


```{r}
neg_p11 <- ggplot(p_na_neg[p_na_neg$Year == "2011",], aes(x = factor(Month), y = neg_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2011")
neg_p12 <- ggplot(p_na_neg[p_na_neg$Year == "2012",], aes(x = factor(Month), y = neg_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2012")
neg_p13 <- ggplot(p_na_neg[p_na_neg$Year == "2013",], aes(x = factor(Month), y = neg_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2013")
neg_p18 <- ggplot(p_na_neg[p_na_neg$Year == "2018",], aes(x = factor(Month), y = neg_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2018")
neg_p19 <- ggplot(p_na_neg[p_na_neg$Year == "2019",], aes(x = factor(Month), y = neg_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2019")
neg_p22 <- ggplot(p_na_neg[p_na_neg$Year == "2022",], aes(x = factor(Month), y = neg_p)) + geom_col() + scale_x_discrete(labels = month.abb) + theme_minimal() + ggtitle("2022")

pplots <- list(neg_p11, neg_p12, neg_p13, neg_p18, neg_p19, neg_p22)

ggarrange(plotlist = pplots, common.legend = TRUE, nrow = 3, ncol = 2, legend = "bottom")
```

```{r}
na11 <- ggplot(na_counts[na_counts$Year == "2011",], aes(x = factor(Month), y = na_count)) +
  geom_col() +
  facet_wrap(~ Year, ncol = 1, scales = "free_y") +
  scale_x_discrete(labels = month.abb) +  # Use abbreviated month names
  theme_minimal() # +
  #labs(title = "Number of NAs per Month for Each Year",
  #     x = "Month",
  #     y = "Number of NAs") +
  #theme(
  #  axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels for readability
  #  panel.spacing = unit(1, "lines")  # Space between facets
  #)

na12 <- ggplot(na_counts[na_counts$Year == "2012",], aes(x = factor(Month), y = na_count)) +
  geom_col() +
  facet_wrap(~ Year, ncol = 1, scales = "free_y") +
  scale_x_discrete(labels = month.abb) +
  theme_minimal()
  
na13 <- ggplot(na_counts[na_counts$Year == "2013",], aes(x = factor(Month), y = na_count)) +
  geom_col() +
  facet_wrap(~ Year, ncol = 1, scales = "free_y") +
  scale_x_discrete(labels = month.abb) +
  theme_minimal()
    
na18 <- ggplot(na_counts[na_counts$Year == "2018",], aes(x = factor(Month), y = na_count)) +
  geom_col() +
  facet_wrap(~ Year, ncol = 1, scales = "free_y") +
  scale_x_discrete(labels = month.abb) +
  theme_minimal()
  
na19 <- ggplot(na_counts[na_counts$Year == "2019",], aes(x = factor(Month), y = na_count)) +
  geom_col() +
  facet_wrap(~ Year, ncol = 1, scales = "free_y") +
  scale_x_discrete(labels = month.abb) +
  theme_minimal()

  
na22 <- ggplot(na_counts[na_counts$Year == "2022",], aes(x = factor(Month), y = na_count)) +
  geom_col() +
  facet_wrap(~ Year, ncol = 1, scales = "free_y") +
  scale_x_discrete(labels = month.abb) +
  theme_minimal()

na_list <- list(na11, na12, na13, na18, na19, na22)

ggarrange(plotlist = na_list, common.legend = TRUE, nrow = 3, ncol = 2, legend = "bottom")

neg_counts <- sa_all %>% group_by(Year, Month) %>% summarise(neg_count = sum(SA_cm3 < 0, na.rm = TRUE))

min_neg = min(neg_counts$neg_count)
max_neg = max(neg_counts$neg_count)

neg11 <- ggplot(neg_counts[neg_counts$Year == "2011",], aes(x = factor(Month), y = neg_count)) + geom_col() + facet_wrap(~ Year, ncol = 1, scales = "free_y") + scale_x_discrete(labels = month.abb) + theme_minimal() # + scale_y_continuous(limits = c(min_neg, max_neg))

neg12 <- ggplot(neg_counts[neg_counts$Year == "2012",], aes(x = factor(Month), y = neg_count)) + geom_col() + facet_wrap(~ Year, ncol = 1, scales = "free_y") + scale_x_discrete(labels = month.abb) + theme_minimal()

neg13 <- ggplot(neg_counts[neg_counts$Year == "2013",], aes(x = factor(Month), y = neg_count)) + geom_col() + facet_wrap(~ Year, ncol = 1, scales = "free_y") + scale_x_discrete(labels = month.abb) + theme_minimal()

neg18 <- ggplot(neg_counts[neg_counts$Year == "2018",], aes(x = factor(Month), y = neg_count)) + geom_col() + facet_wrap(~ Year, ncol = 1, scales = "free_y") + scale_x_discrete(labels = month.abb) + theme_minimal()

neg19 <- ggplot(neg_counts[neg_counts$Year == "2019",], aes(x = factor(Month), y = neg_count)) + geom_col() + facet_wrap(~ Year, ncol = 1, scales = "free_y") + scale_x_discrete(labels = month.abb) + theme_minimal()

neg22 <- ggplot(neg_counts[neg_counts$Year == "2022",], aes(x = factor(Month), y = neg_count)) + geom_col() + facet_wrap(~ Year, ncol = 1, scales = "free_y") + scale_x_discrete(labels = month.abb) + theme_minimal()

neg_list <- list(neg11, neg12, neg13, neg18, neg19, neg22)

ggarrange(plotlist = neg_list, common.legend = TRUE, nrow = 3, ncol = 2, legend = "bottom")

```


```{r}
month_breaks <- as.Date(paste0("2000-", 1:12, "-01"))
```

```{r}

l5 <- mapply(FUN = create_scatter_plot_2,
             model = list(var_all_model[[1]], var_all_model[[2]], var_all_model[[3]], var_all_model[[4]]),
             test_data  = rep(list(test_var_all), 4),
             train_data = rep(list(train_var_all), 4),
             colors = list(c(colors[[1]], "#000000"), c(colors[[2]], "#000000"), c(colors[[3]], "#000000"), c(colors[[4]], "#000000")),
             title = c("Cubist", "Random Forest", "avNNet", "Linear Regression"),
             bgc = rep(c("#E6F0FF"), 4),
             f = factors[1:4],
             alpha = 0.5,
             SIMPLIFY = FALSE)

plot5 <- ggarrange(plotlist = l5, common.legend = TRUE, nrow = 2, ncol = 2, legend = "right")
```

----