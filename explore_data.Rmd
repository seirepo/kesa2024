---
title: "Data exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
setwd("/scratch/dongelr1/susannar/kesa2024")

library(dplyr)
library(lubridate)
library(ggplot2)
library(ggpubr)
library(tidyr) # drop_na
library("scales") # date_breaks
library(purrr)
library('stringr')
#library(zoo) # rollapply
#library(tidyr) # pivot_longer
```

# Explore the unprocessed data


## Functions for loading the unprocessed data
```{r}
rename_smear_columns <- function(df) {
  names(df)[names(df) == "HYY_META.Pamb0"] <- "air_pressure"
  names(df)[names(df) == "HYY_META.T336"] <- "temperature"
  names(df)[names(df) == "HYY_META.Glob"] <- "global_radiation"
  names(df)[names(df) == "HYY_META.NOx336"] <- "NOx"
  names(df)[names(df) == "HYY_META.O3336"] <- "O3"
  names(df)[names(df) == "HYY_META.RHTd"] <- "relative_humidity"
  names(df)[names(df) == "HYY_META.SO2168"] <- "SO2"
  names(df)[names(df) == "HYY_META.WDU336"] <- "wind_direction"
  names(df)[names(df) == "HYY_META.WSU336"] <- "wind_speed"
  return(df)
}

merge_smear_data <- function(folder_path) {
  x <- list.files(path = folder_path, full.names = TRUE) %>%
    lapply(read.csv) %>%
    lapply(function(x) {x$Time <- as.POSIXct(str_c(x$Year, "-", x$Month, "-", x$Day, " ", x$Hour, ":", x$Minute, ":00"), format="%Y-%m-%d %H:%M:%S", tz="UTC");x}) %>%
    lapply(function(x) arrange(x, Time)) %>%
    lapply(function(x) x[!names(x) %in% c("Minute","Second", "Hour", "Day", "Year", "Month")]) %>%
    lapply(function(x) rename_smear_columns(x)) %>%
    lapply(function(x) arrange(x, Time)) %>%
    reduce(cbind) %>%
    .[unique(colnames(.))]
  return(x)
}

load_tol_data <- function(folder_path) {
  x <- list.files(path = folder_path, full.names = TRUE) %>%
    lapply(function(x) read.csv(x, header = TRUE, col.names = c("Time", "ToL", "sector"))) %>%
    #lapply(function(x) {print(nrow(x)); x}) %>%
    lapply(function (x) {y <- mutate(x, Time = as.POSIXct(Time, tz = "UTC", format = "%Y-%m-%d %H:%M:%S")); y}) %>%
    lapply(function(x) arrange(x, Time)) %>%
    reduce(rbind)
  return(x)
}

preprocess_sa_data <- function(folder_path) {
  x <- list.files(path = folder_path, full.names = TRUE) %>%
    lapply(read.table) %>%
    lapply(function(x) {names(x) <- c("Time", "SA_cm3", "3", "4"); x}) %>%
    lapply(function(x) {x[3:4] <- list(NULL); x}) %>%
    lapply(function(x) {y <- mutate(x, Time=as.POSIXct((Time - 719529)*86400, origin = "1970-01-01", tz="UTC")); y}) %>%
    lapply(function(x) arrange(x, Time)) %>%
    reduce(rbind) %>%
    arrange(Time) %>%
    filter((SA_cm3 > -1e5) & (SA_cm3 < 1e9))
    return(x)
}
```




## Explore ToL data

```{r}
tol <- load_tol_data("/scratch/dongelr1/susannar/kesa2024/data/hyytiala/time_over_land/")

tol <- tol %>% mutate(DayMonth = format(Time, "%d-%m")) %>% mutate(DayMonth = paste(DayMonth, "2000", sep="-")) %>% mutate(DayMonth = as.Date(DayMonth, format = "%d-%m-%Y"))

p <- ggplot(tol, aes(x = DayMonth, y = ToL, group = sector)) + geom_point(na.rm = TRUE, aes(shape = factor(sector), color = factor(sector))) + facet_wrap(~year(Time)) + scale_x_date(breaks = "3 months", labels = date_format("%m"))
p

```

Plot the distribution of ToL for each year, grouped by sector
```{r}
ggplot(tol, aes(x = DayMonth), group = sector) + geom_histogram(na.rm = TRUE, aes(color = factor(sector))) + facet_wrap(~year(Time)) + scale_x_date(breaks = "1 month", labels = date_format("%m")) + theme(axis.text.x = element_text(angle = 45, hjust = 1.5))

# Split tol by year, resulting in a list with the years as names and data frames as "values"
tol_by_year <- split(tol, year(tol$Time))

for (year in names(tol_by_year)) {
  tol_year <- tol_by_year[[year]]
  
  p <- ggplot(tol_year, aes(x = ToL)) + #, fill = sector)) +
    geom_histogram(binwidth = 5, aes(colour = factor(sector)), na.rm = TRUE) + #position = "dodge", na.rm = TRUE) +
    labs(title = paste("ToL", year, "(1=Clean, 2=Europe, 3=East, 4=Mixed)"),
         x = "ToL",
         y = "Count") +
    theme_minimal() +
    theme(legend.position = "bottom") +
    facet_wrap(~sector)
  
  print(p)
}

```


Plot histograms of NA values

```{r}
t18 <- tol_by_year[["2018"]]
t19 <- tol_by_year[["2019"]]

# NA values only in 2018 and 2019, there aren't many of them
for (year in names(tol_by_year)) {
  tol_year <- tol_by_year[[year]]
  na_year <- filter(tol_year, is.na(ToL))
  p <- ggplot(na_year, aes(x=Time), group = sector) + geom_histogram(na.rm=TRUE) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle(paste("NAs,", year)) + scale_x_datetime(breaks = "1 month", labels = date_format("%d-%m"))
  print(p)
}

```



## Explore SMEAR data

```{r}
path1113 <- "/scratch/dongelr1/susannar/kesa2024/data/smear_hyytiala_2011_2013/"
path1819 <- "/scratch/dongelr1/susannar/kesa2024/data/smear_hyytiala_2018_2019/"
path22 <- "/scratch/dongelr1/susannar/kesa2024/data/smear_hyytiala_2022/"
hyytiala1113 <- merge_smear_data(path1113)
hyytiala1819 <- merge_smear_data(path1819)
hyytiala22 <- merge_smear_data(path22)

smear_data <- reduce(list(hyytiala1113, hyytiala1819, hyytiala22), rbind)
```


Plot the distributions of negative values of global radiation, NOx and SO2
```{r}
gr <- filter(smear_data, global_radiation < 0)
nox <- filter(smear_data, NOx < 0)
so2 <- filter(smear_data, SO2 < 0)

l <- list(
  p1 <- ggplot(gr, aes(x=hour(Time))) + geom_histogram(na.rm=TRUE, binwidth = 1) + ggtitle("Global radiation"),
  p2 <- ggplot(nox, aes(x=hour(Time))) + geom_histogram(na.rm=TRUE, binwidth = 1) + ggtitle("NOx"),
  p3 <- ggplot(so2, aes(x=hour(Time))) + geom_histogram(na.rm=TRUE, binwidth = 1) + ggtitle("SO2")
)

p1 <- ggarrange(plotlist = l, common.legend = TRUE, nrow = 1, ncol = 3, legend = "bottom")
p1

```


## Explore SA data

### Basic plots

Load SA data, add a Year column in SA dataframes and combine them into one
```{r}
sa_path <- "/scratch/dongelr1/susannar/kesa2024/data/hyytiala/sulphuric_acid/"
sa <- preprocess_sa_data(sa_path)

sa <- sa %>% mutate(Year = paste(year(Time)))
sa$DayMonth <- format(sa$Time, "%d/%m")


sa11 <- filter(sa, year(Time) == 2011)
sa12 <- filter(sa, year(Time) == 2012)
sa13 <- filter(sa, year(Time) == 2013)
sa18 <- filter(sa, year(Time) == 2018)
sa19 <- filter(sa, year(Time) == 2019)
sa22 <- filter(sa, year(Time) == 2022)

```

Plot SA data by year
```{r}

plot_list <- list(
  p2011 <- ggplot(sa11, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2011"),
  p2012 <- ggplot(sa12, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2012"),
  p2013 <- ggplot(sa13, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2013"),
  p2018 <- ggplot(sa18, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2018"),
  p2019 <- ggplot(sa19, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2019"),
  p2022 <- ggplot(sa22, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2022")
)

gridExtra::grid.arrange(grobs = plot_list)
```

Plot all years in log scale
```{r}

plot_list <- list(
  p11 <- ggplot(sa11, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2011") + scale_y_continuous(trans='log10') + ylab("log(SA)"),
  p12 <- ggplot(sa12, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2012") + scale_y_continuous(trans='log10') + ylab("log(SA)"),
  p13 <- ggplot(sa13, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2013") + scale_y_continuous(trans='log10') + ylab("log(SA)"),
  p18 <- ggplot(sa18, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2018") + scale_y_continuous(trans='log10') + ylab("log(SA)"),
  p19 <- ggplot(sa19, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2019") + scale_y_continuous(trans='log10') + ylab("log(SA)"),
  p22 <- ggplot(sa22, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2022") + scale_y_continuous(trans='log10') + ylab("log(SA)")
)

#gridExtra::grid.arrange(grobs = plot_list)
p1 <- ggarrange(plotlist = plot_list, common.legend = TRUE, nrow = 2, ncol = 3, legend = "bottom")
p1
```


Boxplot for SA in log scale for each year
```{r}

bplot_list = list(
  p2018 <- ggplot(sa18, aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2018") + scale_y_continuous(trans='log10'),
  p2019 <- ggplot(sa19, aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2019") + scale_y_continuous(trans='log10'),
  p2022 <- ggplot(sa22, aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2022") + scale_y_continuous(trans='log10'),
  p2011 <- ggplot(sa11, aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2011") + scale_y_continuous(trans='log10'),
  p2012 <- ggplot(sa12, aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2012") + scale_y_continuous(trans='log10'),
  p2013 <- ggplot(sa13, aes(Time, SA_cm3)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("2013") + scale_y_continuous(trans='log10')
)

p <- ggarrange(plotlist = bplot_list, common.legend = TRUE, nrow = 2, ncol = 3, legend = "bottom")
p
```

Plot all years within the same boxplot (execpt 2013)

```{r}

bplots1 <- ggplot(sa[sa$Year %in% c("2011", "2012", "2018", "2019", "2022"),], aes(x=Year, y=SA_cm3, group = Year)) + geom_boxplot(na.rm=TRUE)
bplots2013 <- ggplot(sa[sa$Year %in% c("2013"),], aes(x=Year, y=SA_cm3)) + geom_boxplot(na.rm=TRUE)

bplots1
bplots2013

```


Plot all years as a line/dot plot with the same x axis

```{r}

month_breaks <- as.Date(paste0("2000-", 1:12, "-01"))
month_labels <- month.abb
sa$Date <- as.Date(paste0("2000/", sa$DayMonth), format="%Y/%d/%m")

p <- ggplot(sa, aes(x = Date, y = SA_cm3)) +
  geom_point(na.rm = TRUE) +
  facet_wrap(~ Year, scales = "free_y", ncol = 2, nrow = 3)
p

```

## Plot some random days

Plot only 2013 June when there seems to be more extreme values, compare to the SO2 data from the same day
```{r}
sa13_june <- filter(sa13, month(Time) == 6 & day(Time) >= 27)
p1 <- ggplot(sa13_june, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("SA, June 2013")

sa13_june <- filter(sa13_june, day(Time) >= 27)
p2 <- ggplot(sa13_june, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("SA, June 2013") + scale_y_continuous(trans='log10') + ylab("log(SA)") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

smear11 <- filter(hyytiala1113, year(Time) == 2011 & month(Time) == 6 & day(Time) >= 27)
p3 <- ggplot(smear11, aes(Time, SO2)) + geom_point(na.rm=TRUE) + ggtitle("SO2, June 2013") + scale_y_continuous(trans='log10') + ylab("log(SO2)") + theme(axis.text.x = element_text(angle = 45, hjust = 1))


plot_list = list(p2, p3)
p2 <- ggarrange(plotlist = plot_list, common.legend = TRUE, nrow = 1, ncol = 2, legend = "bottom")
p2

```

Similarly with 2019
```{r}
sa19_jan <- filter(sa19, month(Time) == 1 & day(Time) >= 24 & day(Time) <= 25)
p1 <- ggplot(sa19_jan, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("SA, 2019") + scale_y_continuous(trans='log10') + ylab("log(SA)") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

smear19 <- filter(hyytiala1819, year(Time) == 2019 & month(Time) == 1 & day(Time) >= 24 & day(Time) <= 25)
p2 <- ggplot(smear19, aes(Time, SO2)) + geom_point(na.rm=TRUE) + ggtitle("SO2, 2019") + scale_y_continuous(trans='log10') + ylab("log(SO2)") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_list = list(p1, p2)
p <- ggarrange(plotlist = plot_list, common.legend = TRUE, nrow = 1, ncol = 2, legend = "bottom")
p
```

CLoser look at April 2011, SO2 not available
```{r}
p1 <- ggplot(sa11, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2011") + scale_y_continuous(trans='log10') + ylab("log(SA)")

smear11 <- filter(hyytiala1113, year(Time) == 2011 & month(Time) >= 3 & month(Time) <= 4)
p2 <- ggplot(smear11, aes(Time, SO2)) + geom_point(na.rm=TRUE) + ggtitle("SO2, June 2011") + scale_y_continuous(trans='log10') + ylab("log(SO2)") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_list = list(p1, p2)
p <- ggarrange(plotlist = plot_list, common.legend = TRUE, nrow = 1, ncol = 2, legend = "bottom")
p
```

Plot only negative data for each year
```{r}

nsa11 <- filter(sa11, SA_cm3 < 0)
nsa12 <- filter(sa12, SA_cm3 < 0)
nsa13 <- filter(sa13, SA_cm3 < 0)
nsa18 <- filter(sa18, SA_cm3 < 0)
nsa19 <- filter(sa19, SA_cm3 < 0)
nsa22 <- filter(sa22, SA_cm3 < 0)

plot_list <- list(
  p11 <- ggplot(nsa11, aes(x=Time)) + geom_histogram(na.rm=TRUE) + ggtitle("2011") + theme(axis.text.x = element_text(angle = 45, hjust = 1)),
  p12 <- ggplot(nsa12, aes(x=Time)) + geom_histogram(na.rm=TRUE) + ggtitle("2012") + theme(axis.text.x = element_text(angle = 45, hjust = 1)),
  p13 <- ggplot(nsa13, aes(x=Time)) + geom_histogram(na.rm=TRUE) + ggtitle("2013") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
  #p18 <- ggplot(nsa18, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2018"),
  #p19 <- ggplot(nsa19, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2019"),
  #p22 <- ggplot(nsa22, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2022")
)

#gridExtra::grid.arrange(grobs = plot_list)
p3 <- ggarrange(plotlist = plot_list, common.legend = TRUE, nrow = 1, ncol = 3, legend = "bottom")
p3 <- annotate_figure(p3, top = text_grob("Negative values yearly"))

p3


```


Histograms of negative values yearly
```{r}
p11_1 <- ggplot(nsa11, aes(x=hour(Time))) + geom_histogram(binwidth = 1) + ggtitle("Negative values by hour, 2011") + theme_minimal() 
p11_2 <- ggplot(nsa11, aes(x=SA_cm3)) + geom_histogram(bins=30) + ggtitle("Negative values, 2011") + theme_minimal() 

p11 <- ggarrange(plotlist = list(p11_1, p11_2), common.legend = TRUE, nrow = 1, ncol = 2, legend = "bottom")
p11


p12_1 <- ggplot(nsa12, aes(x=hour(Time))) + geom_histogram(binwidth = 1) + ggtitle("Negative values by hour, 2012") + theme_minimal() 
p12_2 <- ggplot(nsa12, aes(x=SA_cm3)) + geom_histogram(bins=30) + ggtitle("Negative values, 2012") + theme_minimal() 
p12 <- ggarrange(plotlist = list(p12_1, p12_2), common.legend = TRUE, nrow = 1, ncol = 2, legend = "bottom")
p12


plot_list = list(
  p11 <- ggplot(nsa11, aes(x=hour(Time))) + geom_histogram(binwidth = 1) + ggtitle("2011") + theme_minimal(),
  p12 <- ggplot(nsa12, aes(x=hour(Time))) + geom_histogram(binwidth = 1) + ggtitle("2012") + theme_minimal(),
  p13 <- ggplot(nsa13, aes(x=hour(Time))) + geom_histogram(binwidth = 1) + ggtitle("2013") + theme_minimal()
)

p1 <- ggarrange(plotlist = plot_list, common.legend = TRUE, nrow = 1, ncol = 3, legend = "bottom")

plot_list = list(
  p11 <- ggplot(nsa11, aes(x=SA_cm3)) + geom_histogram(bins=30) + ggtitle("2011") + theme_minimal(),
  p12 <- ggplot(nsa12, aes(x=SA_cm3)) + geom_histogram(bins=30) + ggtitle("2012") + theme_minimal(),
  p13 <- ggplot(nsa13, aes(x=SA_cm3)) + geom_histogram(bins=30) + ggtitle("2013") + theme_minimal()
)

p2 <- ggarrange(plotlist = plot_list, common.legend = TRUE, nrow = 1, ncol = 3, legend = "bottom")


annotate_figure(p1, top = text_grob("Negative values by hour"))#, 
               #color = "red", face = "bold", size = 14))

annotate_figure(p2, top = text_grob("Distribution of negative SA values"))#, 
               #color = "red", face = "bold", size = 14))

```

Plot some days from 2011
```{r}
p1 <- ggplot(sa11, aes(Time, SA_cm3)) + geom_line(na.rm=TRUE) + ggtitle("2011, as is")
p1

a4 <- filter(sa11, month(Time) == 4 & day(Time) == 2 & hour(Time) >= 7 & hour(Time) <= 8)
ggplot(a4, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2011, a4") #+ scale_y_continuous(trans='log10')


a1 <- filter(sa11, month(Time) == 4 & day(Time) == 1 & hour(Time) >= 6 & hour(Time) <= 12)
ggplot(a1, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("2011, a1")# + scale_y_continuous(trans='log10')
```



### Plots for filtering

Load and distribute data
```{r}
sa_path <- "/scratch/dongelr1/susannar/kesa2024/data/hyytiala/sulphuric_acid/"
sa <- preprocess_sa_data(sa_path)

sa11 <- filter(sa, year(Time) == 2011)
sa12 <- filter(sa, year(Time) == 2012)
sa13 <- filter(sa, year(Time) == 2013)
sa18 <- filter(sa, year(Time) == 2018)
sa19 <- filter(sa, year(Time) == 2019)
sa22 <- filter(sa, year(Time) == 2022)
```

Define helper functions
```{r}

iqr_filter <- function(d, width, q1 = 0.25, q2 = 0.75) {
  filtered <- d %>%
    mutate(lower = rollapply(d$SA_cm3, width, FUN = function(x) { r <- quantile(x, probs = c(0.25, 0.75)); iqr <- r[2] - r[1]; lower_lim <- r[1] - 1.5*iqr; upper_lim <- r[2] + 1.5*iqr; lower_lim}, align = "center",  fill = NA)) %>%
    mutate(upper = rollapply(d$SA_cm3, width, FUN = function(x) { r <- quantile(x, probs = c(0.25, 0.75)); iqr <- r[2] - r[1]; lower_lim <- r[1] - 1.5*iqr; upper_lim <- r[2] + 1.5*iqr; upper_lim}, align = "center",  fill = NA)) %>%
    filter(is.na(lower) | between(SA_cm3, lower, upper)) %>%
    mutate(lower = NULL, upper = NULL)
  return(filtered)
}

iqr_flag_outliers <- function(d, width, q1 = 0.25, q2 = 0.75) {
    flagged <- d %>%
    mutate(lower = rollapply(d$SA_cm3, width, FUN = function(x) { r <- quantile(x, probs = c(0.25, 0.75)); iqr <- r[2] - r[1]; lower_lim <- r[1] - 1.5*iqr; upper_lim <- r[2] + 1.5*iqr; lower_lim}, align = "center",  fill = NA)) %>%
    mutate(upper = rollapply(d$SA_cm3, width, FUN = function(x) { r <- quantile(x, probs = c(0.25, 0.75)); iqr <- r[2] - r[1]; lower_lim <- r[1] - 1.5*iqr; upper_lim <- r[2] + 1.5*iqr; upper_lim}, align = "center",  fill = NA)) %>%
    mutate(outlier = !(is.na(lower) | between(SA_cm3, lower, upper))) %>%
    mutate(lower = NULL, upper = NULL)
  return(flagged)
}

iqr_plot_flagged_outliers <- function(df, s = "") {
  ggplot(df, aes(x = Time, y = SA_cm3, color = outlier)) +
  geom_point(size = 2, na.rm = TRUE) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  theme_minimal() +
  labs(title = paste("SA cm-3 ", s),
       x = "Date",
       y = "SA_3cm",
       color = "Outlier")
}

get_comparison_df <- function(original_df) {
  
  # unfiltered average
  unfiltered <- compute_SA_30min_average(original_df)
  
  # filter data
  filtered_30 <- iqr_filter(original_df, width = 15)
  filtered_60 <- iqr_filter(original_df, width = 31)
  filtered_240 <- iqr_filter(original_df, width = 121)
  

  rounded1 <- compute_SA_30min_average(filtered_30)
  rounded2 <- compute_SA_30min_average(filtered_60)
  rounded3 <- compute_SA_30min_average(filtered_240)
  
  colnames(rounded1)[2] <- "SA_cm3_30"
  colnames(rounded2)[2] <- "SA_cm3_60"
  colnames(rounded3)[2] <- "SA_cm3_240"

  comp <- reduce(list(unfiltered, rounded1, rounded2, rounded3), cbind)
  comp <- comp[unique(colnames(comp))]

  #comp <- comp %>% mutate(diff1 = SA_cm3 - SA_cm3_30) %>% mutate(diff2 = SA_cm3 - SA_cm3_60) %>% mutate(diff3 = SA_cm3 - SA_cm3_240)

  comp_long <- comp %>%
  pivot_longer(cols = starts_with("SA_cm3"), names_to = "variable", values_to = "value")
  
  return(comp_long)
}

plot_comparison <- function(df, time) {
  #ggplot(df, aes(x = Time, y = value, color = variable)) +
  #geom_point() +
  #theme_minimal() +
  #labs(title = paste("Differences between unfiltered and filtered SA values, ", time),
  #     x = "Time",
  #     y = "value",
  #     color = "variable")
  
  ggplot(df, aes(x = Time, y = value, color = variable)) +
  geom_line(data = subset(df, variable == "SA_cm3"), aes(x = Time, y = value) , color = "black") +
  geom_point(data = subset(df, variable == "SA_cm3_30"), aes(x = Time, y = value), color = "orange") +
  geom_point(data = subset(df, variable == "SA_cm3_60"), aes(x = Time, y = value), color = "red") +
  geom_point(data = subset(df, variable == "SA_cm3_240"), aes(x = Time, y = value), color = "blue") +
  theme_minimal() +
  labs(title = paste("Unfiltered and filtered SA values", time),
       x = "Time",
       y = "SA_cm3",
       color = "variable")
}

compute_SA_30min_average <- function(x) {
  df <- data.frame(x)
  df$Time <- floor_date(df$Time, "30 mins")
  df <- group_by(df, Time)
  df <- summarise(df, SA_cm3 = mean(SA_cm3, na.rm = FALSE))
  return(df)
}
```

Compare the filtering results with different window width
```{r}
sa11_comp <- get_comparison_df(sa11)
sa12_comp <- get_comparison_df(sa12)

sa12_og_rounded <- compute_SA_30min_average(sa12)
s <- filter(sa12_og_rounded, month(Time) == 3 & day(Time) == 27)
ggplot(s, aes(Time, SA_cm3)) + geom_line(na.rm=TRUE) + ggtitle("2012") + scale_y_continuous(trans='log10')

sa11_comp_filtered <- filter(sa11_comp, day(Time) == 23)
sa12_comp_filtered <- filter(sa12_comp, month(Time) == 3 & day(Time) == 27)

plot_comparison(sa11_comp_filtered, 2011)
plot_comparison(sa12_comp_filtered, 2012)

# Create the plot
ggplot(sa12_comp, aes(x = Time, y = value, color = variable)) +
  geom_line() +
  theme_minimal()

f13 <- iqr_flag_outliers(sa18, 31)
f22 <- filter(f13, month(Time) == 7 & day(Time) == 18)
iqr_plot_flagged_outliers(f22, "2018")

h18 <- filter(hyytiala1819, year(Time) == 2018 & month(Time) == 7 & day(Time) >= 18 & day(Time) <= 19)
ggplot(h18, aes(Time, SO2)) + geom_point(na.rm=TRUE) + ggtitle("2013") #+ scale_y_continuous(trans='log10')
```

Plot the whole 2011 and 2012 and some random days to see which values would get filtered out
```{r}

sa11_flagged <- iqr_flag_outliers(sa11, width = 31)
sa12_flagged <- iqr_flag_outliers(sa12, width = 31)

sa12_flagged_sample <- filter(sa12_flagged, month(Time) == 4 & day(Time) == 12 & hour(Time) >= 16 & hour(Time) <= 18)
ggplot(sa12_flagged_sample, aes(x = Time, y = SA_cm3, color = outlier)) +
  geom_point(size = 2, na.rm = TRUE) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  theme_minimal() +
  labs(title = "SA cm-3, 2011",
       x = "Date",
       y = "SA_3cm",
       color = "Outlier") #+
  #scale_y_continuous(trans='log10')

```





# Explore the preprocessed data

```{r}

dat <- read.csv("data/all_data_merged.csv", stringsAsFactors = FALSE)
dat$Time <- ymd_hms(dat$Time, tz = "UTC", truncated = 3)

```


## Basic plots

For each year, plot each column as a boxplot and separate boxplot with log scale if needed

```{r}

dat$Year <- paste(year(dat$Time))

bl <- list(
  airp <- ggplot(dat, aes(Year, air_pressure, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("Air pressure"),
  temp <- ggplot(dat, aes(Year, temperature, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("Temperature"),
  globr <- ggplot(dat, aes(Year, global_radiation, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("Global radiation"),
  nox <- ggplot(dat, aes(Year, NOx, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("NOx"),
  o3 <- ggplot(dat, aes(Year, O3, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("O3"),
  relhum <- ggplot(dat, aes(Year, relative_humidity, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("Relative humidity"),
  so2 <- ggplot(dat, aes(Year, SO2, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("SO2"),
  wdir <- ggplot(dat, aes(Year, wind_direction, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("Wind direction"),
  ws <- ggplot(dat, aes(Year, wind_speed, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("Wind speed"),
  sa <- ggplot(dat, aes(Year, SA_cm3, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("SA"),
  cs <- ggplot(dat, aes(Year, CS_rate, group=Year)) + geom_boxplot(outlier.size=4, na.rm=TRUE) + ggtitle("CS rate")
)

p1 <- ggarrange(plotlist = bl, common.legend = TRUE, nrow = 4, ncol = 3, legend = "bottom")
p1


bl2 <- list(
  globr + scale_y_continuous(trans = "log10") + ylab("log(globar_radiation)"),
  nox + scale_y_continuous(trans = "log10") + ylab("log(NOx)"),
  so2 + scale_y_continuous(trans = "log10") + ylab("log(SO2)"),
  sa + scale_y_continuous(trans = "log10") + ylab("log(SA)"),
  cs + scale_y_continuous(trans = "log10") + ylab("log(CS_rate)")
)

p2 <- ggarrange(plotlist = bl2, common.legend = TRUE, nrow = 1, ncol = 5, legend = "bottom")
p2

```


Negative value and NA counts

```{r}
negative_counts <- sapply(dat[ , 2:12], function(x) sum(x < 0, na.rm = TRUE))
na_counts <- sapply(dat[ , 2:12], function(x) sum(is.na(x)))

negc <- data.frame(negative_vals = negative_counts)
nac <- data.frame(NAs = na_counts)

print(negc)
print(nac)
```


Plot histograms of negative values for each column that has negative values

```{r}

dat$Year_num <- year(dat$Time)

neg_globr <- filter(dat, global_radiation < 0)
neg_nox <- filter(dat, NOx < 0)
neg_so2 <- filter(dat, SO2 < 0)
neg_sa <- filter(dat, SA_cm3 < 0)


# By time, basic
l2 <- list(
  n1 <- ggplot(neg_globr, aes(x=Time)) + geom_histogram(na.rm=TRUE) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Global radiation"),
  n2 <- ggplot(neg_nox, aes(x=Time)) + geom_histogram(na.rm=TRUE) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("NOx"),
  n3 <- ggplot(neg_so2, aes(x=Time)) + geom_histogram(na.rm=TRUE) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SO2"),
  n4 <- ggplot(neg_sa, aes(x=Time)) + geom_histogram(na.rm=TRUE) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SA")
)


p4 <- ggarrange(plotlist = l2, common.legend = TRUE, nrow = 1, ncol = 4, legend = "bottom")
p4 <- annotate_figure(p4, top = text_grob("Negative values"))
p4



# By time, using continuous x (year) instead of date
l2 <- list(
  n1 <- ggplot(neg_globr, aes(x=(year(Time)))) + geom_histogram(na.rm=TRUE) + scale_x_continuous(breaks=c(2011, 2012, 2013, 2018, 2019, 2022)) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Global radiation"),
  n2 <- ggplot(neg_nox, aes(x=year(Time))) + geom_histogram(na.rm=TRUE) + scale_x_continuous(breaks=c(2011, 2012, 2013, 2018, 2019, 2022)) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("NOx"),
  n3 <- ggplot(neg_so2, aes(x=year(Time))) + geom_histogram(na.rm=TRUE) + scale_x_continuous(breaks=c(2011, 2012, 2013, 2018, 2019, 2022)) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SO2"),
  n4 <- ggplot(neg_sa, aes(x=year(Time))) + geom_histogram(na.rm=TRUE) + scale_x_continuous(breaks=c(2011, 2012, 2013, 2018, 2019, 2022)) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SA")
)


p4 <- ggarrange(plotlist = l2, common.legend = TRUE, nrow = 1, ncol = 4, legend = "bottom")
p4 <- annotate_figure(p4, top = text_grob("Negative values"))
p4



d_breaks <- c(as.POSIXct("2011-01-01"), as.POSIXct("2012-01-01"), as.POSIXct("2013-01-01"), as.POSIXct("2018-01-01"))
d_breaks <- seq(as.POSIXct("2011-01-01 00:00:00 UTC"), as.POSIXct("2012-12-31 23:59:59 UTC"), "1 year")

# By time, try to scale the date
l2 <- list(
  n1 <- ggplot(neg_globr, aes(x=Time), group = Year) + geom_histogram(na.rm=TRUE) + scale_x_datetime(breaks = date_breaks("2 years"), labels = date_format("%Y"), limits = c(as.POSIXct("2011-01-01"),  as.POSIXct("2022-12-31"))) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Global radiation"),
  n2 <- ggplot(neg_nox, aes(x=Time)) + geom_histogram(na.rm=TRUE) + scale_x_datetime(breaks = date_breaks("2 years"), labels = date_format("%Y"), limits = c(as.POSIXct("2011-01-01"),  as.POSIXct("2022-12-31"))) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("NOx"),
  n3 <- ggplot(neg_so2, aes(x=Time)) + geom_histogram(na.rm=TRUE) + scale_x_datetime(breaks = date_breaks("2 years"), labels = date_format("%Y"), limits = c(as.POSIXct("2011-01-01"),  as.POSIXct("2022-12-31"))) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SO2"),
  n4 <- ggplot(neg_sa, aes(x=Time), group = year) + geom_histogram(na.rm=TRUE) + scale_x_datetime(breaks = date_breaks("2 years"), labels = date_format("%Y"), limits = c(as.POSIXct("2011-01-01"),  as.POSIXct("2022-12-31"))) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SA")
)


p4 <- ggarrange(plotlist = l2, common.legend = TRUE, nrow = 1, ncol = 4, legend = "bottom")
p4 <- annotate_figure(p4, top = text_grob("Negative values"))
p4


# BEST/WORKING way
# By time, one more grouping attempt with extra effort on y-axis scaling

l2 <- list(
  n1 <- ggplot(neg_globr, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Global radiation"),
  n2 <- ggplot(neg_nox, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("NOx"),
  n3 <- ggplot(neg_so2, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SO2"),
  n4 <- ggplot(neg_sa, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SA")
)

p4 <- ggarrange(plotlist = l2, common.legend = TRUE, nrow = 1, ncol = 4, legend = "bottom")
p4 <- annotate_figure(p4, top = text_grob("Negative values"))
p4


# Get total count of a histogram
#sum(ggplot_build(n1)$data[[1]]$count)

```


Plot histograms of NAs for each column

```{r}
 na_airp <- filter(dat, is.na(air_pressure))
 na_temp <- filter(dat, is.na(temperature))
 na_globr <- filter(dat, is.na(global_radiation))
 na_nox <- filter(dat, is.na(NOx))
 na_o3 <- filter(dat, is.na(O3))
 na_relhum <- filter(dat, is.na(relative_humidity))
 na_so2 <- filter(dat, is.na(SO2))
 na_wdir <- filter(dat, is.na(wind_direction))
 na_ws <- filter(dat, is.na(wind_speed))
 na_sa <- filter(dat, is.na(SA_cm3))
 na_cs <- filter(dat, is.na(CS_rate))

 
l <- list(
  n1 <- ggplot(na_airp, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Air pressure"),
  n2 <- ggplot(na_temp, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Temperature"),
  n3 <- ggplot(na_globr, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Global radiation"),
  n4 <- ggplot(na_nox, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("NOx"),
  n5 <- ggplot(na_o3, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("O3"),
  n6 <- ggplot(na_relhum, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Relative humidity"),
  n7 <- ggplot(na_so2, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SO2"),
  n8 <- ggplot(na_wdir, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Wind direction"),
  n9 <- ggplot(na_ws, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Wind speed"),
  n11 <- ggplot(na_sa, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SA"),
  n10 <- ggplot(na_cs, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("CS rate")
)

p5 <- ggarrange(plotlist = l, common.legend = TRUE, nrow = 4, ncol = 3, legend = "bottom")
p5 <- annotate_figure(p5, top = text_grob("NA values"))
p5
```

Histogram/plot of all the data?
```{r}

l <- list(
  n1 <- ggplot(dat, aes(Time, air_pressure)) + geom_point(na.rm=TRUE) + ggtitle("Air pressure"),
  n2 <- ggplot(dat, aes(Time, temperature)) + geom_point(na.rm=TRUE) + ggtitle("Temperature"),
  n3 <- ggplot(dat, aes(Time, global_radiation)) + geom_point(na.rm=TRUE) + ggtitle("Global radiation"),
  n4 <- ggplot(dat, aes(Time, NOx)) + geom_point(na.rm=TRUE) + ggtitle("NOx"),
  n5 <- ggplot(dat, aes(Time, O3)) + geom_point(na.rm=TRUE) + ggtitle("O3"),
  n6 <- ggplot(dat, aes(Time, relative_humidity)) + geom_point(na.rm=TRUE) + ggtitle("Relative humidity"),
  n7 <- ggplot(dat, aes(Time, SO2)) + geom_point(na.rm=TRUE) + ggtitle("SO2"),
  n8 <- ggplot(dat, aes(Time, wind_direction)) + geom_point(na.rm=TRUE) + ggtitle("Wind direction"),
  n9 <- ggplot(dat, aes(Time, wind_speed)) + geom_point(na.rm=TRUE) + ggtitle("Wind speed"),
  n11 <- ggplot(dat, aes(Time, SA_cm3)) + geom_point(na.rm=TRUE) + ggtitle("SA"),
  n10 <- ggplot(dat, aes(Time, CS_rate)) + geom_point(na.rm=TRUE) + ggtitle("CS rate")
)

p6 <- ggarrange(plotlist = l, common.legend = TRUE, nrow = 4, ncol = 3, legend = "bottom")
#p5 <- annotate_figure(p5, top = text_grob("NA values"))
p6

```

Random plot to show all non-na data, makes no sense
```{r}
 na_airp <- filter(dat, !is.na(air_pressure))
 na_temp <- filter(dat, !is.na(temperature))
 na_globr <- filter(dat, !is.na(global_radiation))
 na_nox <- filter(dat, !is.na(NOx))
 na_o3 <- filter(dat, !is.na(O3))
 na_relhum <- filter(dat, !is.na(relative_humidity))
 na_so2 <- filter(dat, !is.na(SO2))
 na_wdir <- filter(dat, !is.na(wind_direction))
 na_ws <- filter(dat, !is.na(wind_speed))
 na_sa <- filter(dat, !is.na(SA_cm3))
 na_cs <- filter(dat, !is.na(CS_rate))

 
l <- list(
  n1 <- ggplot(na_airp, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Air pressure"),
  n2 <- ggplot(na_temp, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Temperature"),
  n3 <- ggplot(na_globr, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Global radiation"),
  n4 <- ggplot(na_nox, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("NOx"),
  n5 <- ggplot(na_o3, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("O3"),
  n6 <- ggplot(na_relhum, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Relative humidity"),
  n7 <- ggplot(na_so2, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SO2"),
  n8 <- ggplot(na_wdir, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Wind direction"),
  n9 <- ggplot(na_ws, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Wind speed"),
  n11 <- ggplot(na_sa, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("SA"),
  n10 <- ggplot(na_cs, aes(x=Year), group = Year) + geom_histogram(na.rm=TRUE, stat = "count") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("CS rate")
)

p7 <- ggarrange(plotlist = l, common.legend = TRUE, nrow = 4, ncol = 3, legend = "bottom")
p7 <- annotate_figure(p7, top = text_grob("Non NA data"))
p7
```


## Replicate plots from A statistical proxy for sulphuric acid concentration

For each year, try to replicate plots in the paper A statistical proxy for sulphuric acid concentration.

```{r}

dat_filtered <- filter(dat, global_radiation > 10 & SO2 > 0.1)
ggplot(dat_filtered, aes(x = CS_rate, y = SA_cm3)) + geom_point(na.rm = TRUE, shape = 1) + scale_y_continuous(trans = "log10") + scale_x_continuous(trans = "log10") + facet_wrap(~year(Time)) + ggtitle("Filtered data with global radiation > 10 and SO2 > 0.1")

#ggplot(dat_filtered, aes(x = CS_rate^(-1), y = SA_cm3)) + geom_point(na.rm = TRUE, shape = 1) + scale_y_continuous(trans = "log10") + scale_x_continuous(trans = "log10") + facet_wrap(~year(Time))

#View(dat %>% mutate(CS_RH = dat$CS_rate * dat$relative_humidity) %>% filter(!is.na(CS_RH)))

dat_filtered %>% mutate(CS_RH = dat_filtered$CS_rate * dat_filtered$relative_humidity) %>% ggplot(aes(x = CS_RH, y = SA_cm3)) + geom_point(na.rm = TRUE, shape = 1) + scale_y_continuous(trans = "log10") + scale_x_continuous(trans = "log10") + facet_wrap(~year(Time)) + ggtitle("Filtered data with global radiation > 10 and SO2 > 0.1")


```


## Correlation matrix

```{r}
library(corrplot)

test_df <- select(dat, -Time, -Year, -Year_num, -wind_direction)
corr <- cor(x = test_df, use = "pairwise.complete.obs")

corrplot(corr, method = "number")
corrplot(corr, method = "color", order = "alphabet")
corrplot(corr)
corrplot(corr, method = "ellipse")#, type = "upper")
```







